# Database Schema Reference

## Overview
This document provides a comprehensive reference for the Flexwise database schema, including tables, relationships, and key patterns for Supabase integration.

## Authentication Pattern
- **Supabase Auth** → `auth.users.user_metadata.profile_id` → `user_profiles.id`
- Use `auth.get_profile_id()` to get current user's profile ID
- Use `auth.get_user_school_id()` to get current user's school

## Key Enums

### Account Status
```sql
account_status_enum: 'none' | 'created' | 'invited' | 'active' | 'inactive' | 'expired' | 'suspended' | 'deleted'
```

### Attendance Status
```sql
attendance_status: 'present' | 'late' | 'absent_unexcused' | 'absent_excused' | 'left_early'
```

### Presence Status
```sql
presence_status: 'present' | 'absent_unexcused' | 'absent_excused' | 'unmarked' | 'left_early' | 'left_without_notice' | 'temporarily_offsite' | 'late' | 'partial'
```

## Core Tables

### user_profiles
**Purpose**: Central profile for all users (students, staff, parents, contacts)

```sql
CREATE TABLE user_profiles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id uuid NOT NULL,
    first_name text,
    last_name text,
    date_of_birth date,
    gender text,
    profile_picture_url text,
    role_id uuid,
    account_status account_status_enum DEFAULT 'none',
    created_at timestamp DEFAULT now()
);
```

**Key Relationships:**
- `school_id` → `structure_schools(id)` ON DELETE CASCADE
- `role_id` → `roles(id)` ON DELETE SET NULL

**Auth Connection:** `auth.users.user_metadata.profile_id` → `user_profiles.id`

### roles
**Purpose**: Role definitions (Teacher, Parent, Admin, Student, etc.)

```sql
CREATE TABLE roles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    name text NOT NULL,
    is_subrole boolean DEFAULT false
);
```

**Common Values:** 'Teacher', 'Parent', 'Admin', 'Student', 'Super Admin', 'Externe'

### user_roles
**Purpose**: Multi-role assignment (users can have multiple roles)

```sql
CREATE TABLE user_roles (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_profile_id uuid NOT NULL,
    role_id uuid NOT NULL,
    school_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now()
);
```

**Relationships:**
- `user_profile_id` → `user_profiles(id)`
- `role_id` → `roles(id)`
- `school_id` → `structure_schools(id)`

### structure_schools
**Purpose**: School entities for multi-tenancy

```sql
CREATE TABLE structure_schools (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    name text NOT NULL,
    timezone text,
    language text,
    principal_id uuid,
    email text,
    phone text,
    address_street text,
    address_city text,
    address_postal_code text
);
```

### structure_classes
**Purpose**: Class/classroom definitions

```sql
CREATE TABLE structure_classes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id uuid NOT NULL,
    name text NOT NULL,
    year integer NOT NULL,
    teacher_id uuid,
    grade_level integer,
    room_id uuid,
    color text
);
```

**Relationships:**
- `school_id` → `structure_schools(id)` ON DELETE CASCADE
- `teacher_id` → `user_profiles(id)`
- `room_id` → `structure_rooms(id)` ON DELETE SET NULL

## Student & Family Management

### profile_info_student
**Purpose**: Student-specific profile information

```sql
CREATE TABLE profile_info_student (
    profile_id uuid NOT NULL,
    class_id uuid,
    school_id uuid NOT NULL,
    date_of_birth date,
    middle_name text,
    nickname text,
    allergies text,
    authorized_pickup_ids uuid[] DEFAULT '{}',
    notes text
);
```

### families
**Purpose**: Family groupings for managing parent-child relationships

```sql
CREATE TABLE families (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id uuid NOT NULL,
    created_by uuid,
    updated_by uuid,
    created_at timestamp DEFAULT now()
);
```

### family_members
**Purpose**: Links profiles to families with roles

```sql
CREATE TABLE family_members (
    family_id uuid NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL, -- 'student', 'parent', 'guardian', 'staff', 'other'
    relation_description text,
    is_primary_guardian boolean,
    is_primary_contact boolean,
    added_at timestamp DEFAULT now(),
    school_id uuid NOT NULL
);
```

### family_member_child_links
**Purpose**: Adult-child relationships with permissions

```sql
CREATE TABLE family_member_child_links (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id uuid NOT NULL,
    adult_profile_id uuid NOT NULL,
    child_profile_id uuid NOT NULL,
    relationship text,
    access_restricted boolean DEFAULT false,
    authorized_for_pickup boolean DEFAULT false,
    pickup_priority smallint,
    school_id uuid NOT NULL
);
```

## Attendance System

### student_daily_log
**Purpose**: Daily attendance tracking per student

```sql
CREATE TABLE student_daily_log (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid NOT NULL,
    school_id uuid NOT NULL,
    date date NOT NULL,
    check_in_time time,
    check_out_time time,
    check_in_by uuid,
    check_out_by uuid,
    presence_status presence_status DEFAULT 'unmarked',
    expected_arrival_time time,
    expected_checkout_time time,
    absence_note_id uuid,
    notes text,
    created_at timestamp DEFAULT now(),
    updated_at timestamp DEFAULT now()
);
```

### student_attendance_logs
**Purpose**: Lesson-level attendance tracking

```sql
CREATE TABLE student_attendance_logs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    lesson_id uuid NOT NULL,
    student_id uuid NOT NULL,
    daily_log_id uuid,
    status attendance_status,
    lateness_duration_minutes integer,
    recorded_by uuid,
    timestamp timestamp DEFAULT now(),
    notes text,
    absence_note_id uuid,
    school_id uuid NOT NULL
);
```

**Relationships:**
- `lesson_id` → `course_lessons(id)` ON DELETE RESTRICT
- `student_id` → `user_profiles(id)`
- `recorded_by` → `user_profiles(id)`

### student_absence_notes
**Purpose**: Absence requests and approvals

```sql
CREATE TABLE student_absence_notes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid NOT NULL,
    school_id uuid NOT NULL,
    created_by uuid NOT NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    absence_type text NOT NULL,
    reason text,
    is_excused boolean DEFAULT false,
    status text DEFAULT 'pending',
    approved_by uuid,
    approved_at timestamp,
    attachment_url text,
    created_at timestamp DEFAULT now()
);
```

## Course & Lesson Management

### course_list
**Purpose**: Course definitions

```sql
CREATE TABLE course_list (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    school_id uuid NOT NULL,
    name text NOT NULL,
    course_code text,
    subject_id uuid,
    max_students integer,
    start_date date,
    end_date date,
    is_active boolean DEFAULT true,
    created_at timestamp DEFAULT now()
);
```

### course_lessons
**Purpose**: Individual lesson instances

```sql
CREATE TABLE course_lessons (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id uuid,
    subject_id uuid,
    class_id uuid,
    room_id uuid,
    primary_teacher_id uuid,
    teacher_ids uuid[] DEFAULT ARRAY[]::uuid[],
    start_datetime timestamp NOT NULL,
    end_datetime timestamp NOT NULL,
    is_cancelled boolean DEFAULT false,
    notes text,
    school_id uuid NOT NULL
);
```

### course_enrollments
**Purpose**: Student enrollment in courses

```sql
CREATE TABLE course_enrollments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid NOT NULL,
    course_id uuid NOT NULL,
    school_id uuid NOT NULL,
    assigned_at timestamp DEFAULT now(),
    start_date date DEFAULT CURRENT_DATE,
    end_date date DEFAULT CURRENT_DATE + interval '90 days',
    is_trial boolean DEFAULT false
);
```

## Contact Management

### contacts
**Purpose**: Contact information for profiles

```sql
CREATE TABLE contacts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    profile_id uuid NOT NULL,
    profile_type text NOT NULL,
    type text NOT NULL, -- 'email', 'phone'
    label text,
    value text NOT NULL,
    is_primary boolean DEFAULT false,
    is_linked_to_user_login boolean DEFAULT false,
    status text DEFAULT 'valid',
    notes text,
    school_id uuid NOT NULL,
    created_at timestamp DEFAULT now()
);
```

## Key Auth Functions

### Available Helper Functions
```sql
-- Get current user's profile ID
auth.get_profile_id() → uuid

-- Get current user's school ID  
auth.get_user_school_id() → uuid

-- Get user's role name
auth.get_user_role() → text

-- Get accessible children (for parents)
auth.get_accessible_children() → uuid[]

-- Get accessible class IDs
auth.get_accessible_class_ids() → uuid[]
```

## Common Query Patterns

### Get User Profile with Role
```sql
SELECT up.*, r.name as role_name
FROM user_profiles up
LEFT JOIN roles r ON up.role_id = r.id  
WHERE up.id = auth.get_profile_id();
```

### Get User's Multiple Roles
```sql
SELECT array_agg(r.name) as roles
FROM user_roles ur
JOIN roles r ON ur.role_id = r.id
WHERE ur.user_profile_id = auth.get_profile_id();
```

### Get Student's Daily Attendance
```sql
SELECT * FROM student_daily_log 
WHERE student_id = $1 
  AND date = $2 
  AND school_id = auth.get_user_school_id();
```

### Get Lesson Attendance
```sql
SELECT sal.*, up.first_name, up.last_name
FROM student_attendance_logs sal
JOIN user_profiles up ON sal.student_id = up.id
WHERE sal.lesson_id = $1
  AND sal.school_id = auth.get_user_school_id();
```

## Security Notes

- **Row Level Security (RLS)**: Most tables implement RLS policies based on `school_id`
- **Multi-tenancy**: All data is scoped by `school_id` for data isolation
- **Profile-based Access**: Use `auth.get_profile_id()` for user-specific queries
- **Family Access**: Parents can only access their authorized children via `family_member_child_links`

## Common Relationships Summary

```
user_profiles (central hub)
├── roles (via role_id)
├── user_roles (many-to-many roles)
├── structure_schools (via school_id)
├── contacts (profile contact info)
├── family_members (family relationships)
├── profile_info_student (student details)
├── profile_info_staff (staff details)
├── student_daily_log (daily attendance)
├── student_attendance_logs (lesson attendance)
└── course_enrollments (course assignments)
```
